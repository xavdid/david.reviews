---
import { loadMaterializedWatches } from "../../airtable/data/watches";
import Moviebox from "../../components/infoboxes/moviebox.astro";
import ExternalLink from "../../components/links/ExternalLink.astro";
import Layout from "../../layouts/Layout.astro";

const watches = await loadMaterializedWatches();
const watchCounts: { [tmdbId: string]: number } = {};

const watchesWithCounts = watches.map((watch) => {
  const thisWatchNum = watchCounts[watch.movie.tmdbId] ?? 0;
  watchCounts[watch.movie.tmdbId] = thisWatchNum + 1;
  return {
    ...watch,
    numWatch: watch.movie.numWatches - thisWatchNum,
  };
});
---

<Layout title="Movies!" active="movies">
  <h1 class="pb-3 pt-2 text-2xl">Every Reviewed Movie</h1>
  <p class="pb-3">
    There are {watchesWithCounts.length} total reviews of {
      Object.keys(watchCounts).length
    } movies.
  </p>
  <ul class="mb-3 rounded bg-red-50 p-2">
    <li>
      <code>*</code> - this is my first <em>logged</em> watch, but I had seen
      the movie before.
    </li>
    <li>
      ðŸ¥‡ / ðŸ¥ˆ / ðŸ¥‰ -
      <ExternalLink href="https://xavd.id/blog/tags/yearly-review">
        Favorite of the Year
      </ExternalLink> honoree.
    </li>
  </ul>
  <div>
    {
      watchesWithCounts.map((watch) => (
        <Moviebox
          title={watch.movie.title}
          yearReleased={watch.movie.yearReleased}
          rating={watch.rating}
          watchedOn={watch.dateWatched}
          posterUrl={watch.movie.posterUrl}
          notes={watch.notes}
          numWatch={watch.numWatch}
          isFirstWatch={watch.isFirstWatch}
          awardTier={watch.movie.award?.tier}
          collections={watch.movie.collections}
        />
      ))
    }
  </div>
</Layout>
 ../../airtable/watches ../../airtable/data/watches
