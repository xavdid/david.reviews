---
import slugify from "@sindresorhus/slugify";

import {
  loadMaterializedReads,
  type MaterializedRead,
} from "../../../airtable/data/reads";
import BookBox from "../../../components/infoboxes/bookbox.astro";
import Layout from "../../../layouts/Layout.astro";
import BookLegend from "../../../components/BookLegend.astro";
import type { MaterializedAuthor } from "../../../airtable/data/authors";
import { authorPermalink } from "../../../utils";

type Params = {
  authorSlug: string;
};

type Props = MaterializedAuthor & {
  reads: MaterializedRead[];
};

// own row for weird export reasons
type Result = Promise<Array<{ params: Params; props: Props }>>;
export const getStaticPaths = async (): Result => {
  const reads = await loadMaterializedReads();

  const authors = reads.reduce<{ [authorId: string]: Props }>(
    (result, read) => {
      read.book.authors.forEach((author) => {
        const authorId = author.recordId;
        const authorRecord = result[authorId];

        if (authorRecord) {
          authorRecord.reads.push(read);
        } else {
          result[authorId] = {
            ...author,
            reads: [read],
          };
        }
      });
      return result;
    },
    {},
  );

  return Object.entries(authors).map(([_, props]) => ({
    params: { authorSlug: authorPermalink(props.slug) },
    props,
  }));
};

const { reads, name, recordId } = Astro.props;
const numUniqueBooks = new Set(reads.map((r) => r.book.gbid)).size;
---

<Layout title={`${name} - Reviews`} active="books">
  <h1 class="pb-3 pt-2 text-2xl">
    Reviews for {name}
  </h1>
  <p class="pb-3">
    There are {reads.length} total reviews of {numUniqueBooks} book{
      reads.length > 1 && "s"
    } by {name}.
  </p>
  <BookLegend />
  <div>
    {
      reads.map((read) => (
        <BookBox
          title={read.book.name}
          rating={read.rating}
          dateFinished={read.dateFinished}
          notes={read.notes}
          isReread={read.isReread}
          googleBooksId={read.book.gbid}
          awardTier={read.book.award?.tier}
          bookMedium={read.medium}
          series={
            read.book.series
              ? {
                  name: read.book.series.name,
                  number: read.book.numberInSeries!,
                }
              : undefined
          }
          coAuthors={true}
          authors={read.book.authors.filter((a) => a.recordId !== recordId)}
        />
      ))
    }
  </div>
</Layout>
